---
title: “Actor“
date: 2022-03-16 11:48:23
---

> 帮助而不是约束，容许摆脱特定框架的束缚。

[TOC]

### 聚合器

由于 actor 封装了它自己的状态，只能通过它定义的访问方法来查询一个 actor 状态。这意味着要汇总多个 actor 的状态，必须一个一个的探测它们并聚合结果。但聚合结果并不是整个系统的一致性快照，因为跨 actor 实例的轮询导致的时间差，扭曲了最终的汇总结果。即使尝试通过启动数以千计的线程并行轮询所有连接的设备，快照仍然会有偏差，因为这些线程并不是同步的。

由于 Dapr 没有使用私有的 actor 状态格式，因此可以直接从底层的数据存储中很容易的查询到 actor 状态。通过直接查询数据库，以单个数据库查询的代价，获得所有 actor 状态的一致性快照。

一个聚合器 actor 将上述的的查询封装成一个易于使用的接口，允许用户运行以 oData、T-SQL、Gremlin 等标准格式编写的查询，能够执行常见的聚合操作，如 sum(), average(percentile p)等。

### 查询接口

通过元数据，对 actor 归组和过滤，如把 actor 实例与标签关联在一起，按标签过滤来提供有限的查询能力。要查询所有需要维护的电梯(由 actor 来代表)，用户可以按上次记录的维护日期为过滤条件执行查询。

### Actor 图

一个 actor 图允许多个 actor 实例动态的链接在一起组成一张图，并将其视为单一的 actor 实例。一旦产生的连接，就无法再更新其中的任意一个。但是，可以将合并后的实例当成一个新的 actor 实例来操作。

组合后的 actor 实例暴露了与单个 actor 实例相同的接口，并且当接收到调用时，它将沿着依赖关系链把调用分发到各个 actor 实例中去。

图的 actor 实例，将会确保所有的配置更新，要么全部提交，要么全部回滚。

### 多版本 Actor

多版本 actor 自动维护了 actor 状态的最近 n 个版本。除了常规的状态访问方法之外，还支持如 moving_average、max、min 等方法。

多版本 actor 还可以配置成按照状态在历史窗口(history window)中如何变化来触发相关的动作，如声音传感器可以被配置成对读数突然变化产生响应。

### Actor 中间件

如通过中间件，来修改 dapr sidecar 的行为一样，也可以在 actor 状态访问的方法上使用中间件。可以插入不同的数据转换或规范化中间件来实现数据的互操作性，而不用修改 actor 自身。
