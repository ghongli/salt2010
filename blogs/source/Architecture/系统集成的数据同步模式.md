---
title: “系统集成的数据同步模式”
date: 2022-03-10 10:11:15
---

> 系统集成中，最常见的一项任务是让两个或更多的系统保持同步，即数据在两边是保持同步的，以避免不必要的冲突。

### 模式

#### 共享数据库

共享数据库模式听起来可能是引入了一个紧耦合，但提供了一种在系统之间，同步大量数据的有效方法。实施时，应当考虑专门为同步的目的设置一个数据库或表，而不是强制系统共享同一份数据库的 schema。通过这样做，可以更灵活的独立迭代每一个系统。

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h04mp74mwlj20d60fmt96.jpg" alt="共享数据库" style="zoom:67%;" />

- 封装同步 API 并使用中间件来定制数据同步管道
  - 配置两个系统，使得它们用来同步的状态存储，指向同一个数据库。
  - 利用中间件机制来插入额外的数据处理能力。

如果直接共享数据库不可行，也可以利用选型的数据库平台上现成的数据同步解决方案。但是，数据只能保证最终一致，需要确保系统的设计能够应对暂时的不一致。

#### 收件箱/发件箱及邮递员

收件箱/发件箱是一种简单且随意的同步机制。在这种模式下，每个系统都维护一个收件箱和一个可先的发件箱。每当一个系统需要与另一个系统同步时，就会向目标发送一条消息。此消息包含了要同步的数据，或如何获取更新数据的指令。

不是一个严格的数据同步模式，允许系统将更改通知彼此，且接收方可以选择回应或将其丢弃。

<img src="/Users/ghongli/gData/relax/books/Architecture/同步/收件箱_发件箱的不同模式.jpeg" alt="收件箱_发件箱的不同模式" style="zoom:67%;" />

依靠系统间的消息直接传递，假定了所有系统都了解彼此，或者至少知道对方的收件箱。但这个假设是不可取的，理由是：

- 当一个系统需要和多个系统同步时，必须向每个系统都发送一个消息。
- 收件箱的地址必须在所有参与的系统上配置并彼此交换，这带来了额外的管理开销。

2. 发布/订阅允许一个系统同时通知多个系统，并且系统无需知道目标收件箱地址。仅需要把消息发布到一个事先约定的主题上。

   采用这个设计的告诫是：因为所有的系统都订阅了相同的主题，系统需要过滤掉自己发送的消息。

3. 一个替代设计是，每个系统发布到自己的 `outgoing` 主题上，并且接收系统将订阅该主题。

使用收件箱/发件箱模式时，还可以考虑引入邮递员的概念。邮递员是一个集中式消息处理器，在收件箱和发件箱之间转移消息。好处是可以通过控制邮递员来集中的管理集成拓扑以及同步策略。另外，还可以为邮递员专门搭建基础设施并配置合理的容量，从面减轻单个系统上的消息处理负担。

通过消息传递来进行同步十分强大，因为在容许系统间集成的同时，保持了系统的松耦合。

#### 事件溯源

事件溯源模式的要点是把所有状态的变动，视为`事件`。例如，当管理银行账号时，不是直接更新账户的余额，而是将所有的提款和存款记录为事件。要获得账户的余额，可以从初始余额开始，然后回放在这个账户中曾经发生过的所有事件。但是，一些优化是必要的，如通过定期的创建账户余额检查点的手段，就可以只在检查点之后，才应用事件。

事件溯源模式有很多的好处和应用：

1. 回退到系统中的任意时间点，如需要更正较早时的交易。

   如果需要更正发生在一个月以前的一笔交易，可以将系统的状态倒回到这笔交易之前，修正这笔交易，然后再回放其余记录的事件即可。

2. 允许将事件放到其他环境中进行诊断。

   如果要调试生产环境中发生的一个问题，可以所事件传送到一个单独的环境里进行回放，然后分析问题的根源。然后，可以在生产数据的副本上测试解决方案，并仅在确信一切就绪之后，再将更改应用到生产环境中。

3. 对数据库使用仅追加操作。这样做的目的是避免数据库更新，与插入操作相比，更新通常更昂贵，性能更差。

   当更新一条记录时，需要在这条记录上加锁，以避免写冲突；而锁可能会导致锁升级、死锁等问题。

4. 把更新和读取分开，从而使得所有的读操作不会被写入中断。事件可以被不同的方式来回放和聚合，为快速查询生成重新填充的视图。

5. 搭建一个备份和还原系统。可以归档所有的事件，并通过回放把系统还原到任何时间点。

使用事件溯源模式进行同步，方法是将事件从一个系统传递到另一个系统中回放。使用状态存储接口，实现一个仅追加的状态存储。简单来说，Set 方法将更新的事件追加到数据库中，而不是更新现有的记录，而 Read 方法则根据应用的需求，以一定的频度维护检查点。从最近已知的检查点开始读取，并从该点开始回放事件。