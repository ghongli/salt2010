# MySQL 索引

索引是数据库高效获取数据的有序数据结构。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用或指向数据，这样就可以在这些数据结构上实现高级查询算法，这种数据结构就是索引。

优点：
- 提高数据检索效率，降低数据库的IO成本
- 通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗

缺点：
- 索引列也要占用空间
- 索引提高了查询效率，但降低了更新的速度，如insert, update, delete

## 索引结构

|索引结构|描述|
| :--- | :--- |
|B+Tree||
|Hash|底层数据结构是用哈希表实现，只有精确匹配索引列的查询才有效，不支持范围查询|
|R-Tree(空间索引)|空间索引是 MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少|
|Full-Text(全文索引)|是一种通过建立倒排索引，快速匹配文档的方式，类似于 Lucene, Solr, ES|

|索引|InnoDB|MyISAM|Memory|
| :--- | :--- | :--- | :--- |
|B+Tree索引|支持|支持|支持|
|Hash索引|不支持|不支持|支持|
|R-Tree索引|不支持|支持|不支持|
|Full-Text索引|5.6版本后支持|支持|不支持|

### B+Tree

二叉树的缺点：顺序插入时，会形成一个链表，查询性能大大降低；大数据量情况下，层级较深，检索速度慢。可以用红黑树来解决。
红黑树也存在大数据量情况下，层级较深，检索速度慢的问题。
为了解决上述问题，可以使用B-Tree结构。BTree (多路平衡查找树) 以一棵最大度数（max-degree，指一个节点的子节点个数）为5（5阶）的 b-tree 为例（每个节点最多存储4个key，5个指针）。
> [演示 BTree Visualization](https://www.cs.usfca.edu/~galles/visualization/BTree.html)
> [演示 B+Tree Visualization](https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html)

B+Tree、BTree 的区别：
- 所有的数据都会出现在叶子节点
- 叶子节点形成一个单向链表

MySQL 索引数据结构对经典的 B+Tree 进行了优化。在原 B+Tree 的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的 B+Tree，提高区间访问的性能。

### Hash

哈希索引就是采用一定的hash算法，将键值换算成新的hash值，映射到对应的槽位上，然后存储在hash表中。 
如果两个（或多个）键值，映射到一个相同的槽位上，他们就产生了hash冲突（也称为hash碰撞），可以通过链表来解决。

特点：
- Hash索引只能用于对等比较（=、in），不支持范围查询（betwwn、>、<、...）
- 无法利用索引完成排序操作
- 查询效率高，通常只需要一次检索就可以了，效率通常要高于 B+Tree 索引

存储引擎支持情况：
- Memory
- InnoDB: 具有自适应hash功能，hash索引是存储引擎根据 B+Tree 索引在指定条件下自动构建的

### 一些问题

1. 为什么 InnoDB 存储引擎选择使用 B+Tree 索引结构？
   - 相对于二叉树，层级更少，搜索效率高
   - 对于BTree，无论是叶子节点，还是非叶子节点，都会保存数据，但这样导致一页中存储的键值减少，指针也跟着减少，要同样保存大量数据，只能增加树的高度，导致性能降低。
   - 相对于Hash索引，B+Tree支持范围匹配及排序操作

## 索引分类
